@using CriticalPath.Web.Models
@using CriticalPath.Data
@using CP.i8n
@model PurchaseOrderEditVM

@Html.HiddenFor(m => m.SizeRate1Id)
@Html.HiddenFor(m => m.SizeRate2Id)
@Html.HiddenFor(m => m.SizeRate3Id)
@Html.HiddenFor(m => m.SizeRate4Id)
@Html.HiddenFor(m => m.SizeRate5Id)
@Html.HiddenFor(m => m.SizeRate6Id)
@Html.HiddenFor(m => m.SizeRate7Id)
@Html.HiddenFor(m => m.SizeRate8Id)
@Html.HiddenFor(m => m.SizeRate9Id)
@Html.HiddenFor(m => m.SizeRate10Id)
@Html.HiddenFor(m => m.SizeRate11Id)
@Html.HiddenFor(m => m.SizeRate12Id)
<div class="form-group">
    @Html.LabelFor(model => model.SizingStandardId, htmlAttributes: new { @class = "control-label col-lg-2 col-md-3 col-sm-3" })
    <div class="col-lg-5 col-md-6 col-sm-7">
        @if (Model.SizingStandardId > 0)
        {
            @Html.DropDownListFor(m => m.SizingStandardId, null, ActionStrings.SelectPlease, htmlAttributes: new { @class = "form-control", @readonly = "readonly" })
        }
        else
        {
            @Html.DropDownListFor(m => m.SizingStandardId, null, ActionStrings.SelectPlease, htmlAttributes: new { @class = "form-control" })
        }
        @Html.ValidationMessageFor(m => m.SizingStandardId, "", new { @class = "text-danger" })
    </div>
</div>
<div class="form-group">
    <label class="control-label col-lg-2 col-md-3 col-sm-3">@EntityStrings.SizeRatios</label>
    <div class="col-lg-7 col-md-8 col-sm-9">
        <div class="col-xs-2 pl0 mb5">
            @Html.EditorFor(m => m.Size1Caption, new { htmlAttributes = new { @class = "form-control", autocomplete = "off", @readonly = "readonly", disabled = "true" } })
        </div>
        <div class="col-xs-2 pl0 mb5">
            @Html.EditorFor(m => m.Size1Rate, new { htmlAttributes = new { @class = "form-control", autocomplete = "off", min = 0 } })
        </div>
        <div class="col-xs-2 pl0 mb5">
            @Html.EditorFor(m => m.Size2Caption, new { htmlAttributes = new { @class = "form-control", autocomplete = "off", @readonly = "readonly", disabled = "true" } })
        </div>
        <div class="col-xs-2 pl0 mb5">
            @Html.EditorFor(m => m.Size2Rate, new { htmlAttributes = new { @class = "form-control", autocomplete = "off", min = 0 } })
        </div>
        <div class="col-xs-2 pl0 mb5">
            @Html.EditorFor(m => m.Size3Caption, new { htmlAttributes = new { @class = "form-control", autocomplete = "off", @readonly = "readonly", disabled = "true" } })
        </div>
        <div class="col-xs-2 pl0 mb5">
            @Html.EditorFor(m => m.Size3Rate, new { htmlAttributes = new { @class = "form-control", autocomplete = "off", min = 0 } })
        </div>
        <div class="col-xs-2 pl0 mb5">
            @Html.EditorFor(m => m.Size4Caption, new { htmlAttributes = new { @class = "form-control", autocomplete = "off", @readonly = "readonly", disabled = "true" } })
        </div>
        <div class="col-xs-2 pl0 mb5">
            @Html.EditorFor(m => m.Size4Rate, new { htmlAttributes = new { @class = "form-control", autocomplete = "off", min = 0 } })
        </div>
        <div class="col-xs-2 pl0 mb5">
            @Html.EditorFor(m => m.Size5Caption, new { htmlAttributes = new { @class = "form-control", autocomplete = "off", @readonly = "readonly", disabled = "true" } })
        </div>
        <div class="col-xs-2 pl0 mb5">
            @Html.EditorFor(m => m.Size5Rate, new { htmlAttributes = new { @class = "form-control", autocomplete = "off", min = 0 } })
        </div>
        <div class="col-xs-2 pl0 mb5">
            @Html.EditorFor(m => m.Size6Caption, new { htmlAttributes = new { @class = "form-control", autocomplete = "off", @readonly = "readonly", disabled = "true" } })
        </div>
        <div class="col-xs-2 pl0 mb5">
            @Html.EditorFor(m => m.Size6Rate, new { htmlAttributes = new { @class = "form-control", autocomplete = "off", min = 0 } })
        </div>
        <div class="col-xs-2 pl0 mb5">
            @Html.EditorFor(m => m.Size7Caption, new { htmlAttributes = new { @class = "form-control", autocomplete = "off", @readonly = "readonly", disabled = "true" } })
        </div>
        <div class="col-xs-2 pl0 mb5">
            @Html.EditorFor(m => m.Size7Rate, new { htmlAttributes = new { @class = "form-control", autocomplete = "off", min = 0 } })
        </div>
        <div class="col-xs-2 pl0 mb5">
            @Html.EditorFor(m => m.Size8Caption, new { htmlAttributes = new { @class = "form-control", autocomplete = "off", @readonly = "readonly", disabled = "true" } })
        </div>
        <div class="col-xs-2 pl0 mb5">
            @Html.EditorFor(m => m.Size8Rate, new { htmlAttributes = new { @class = "form-control", autocomplete = "off", min = 0 } })
        </div>
        <div class="col-xs-2 pl0 mb5">
            @Html.EditorFor(m => m.Size9Caption, new { htmlAttributes = new { @class = "form-control", autocomplete = "off", @readonly = "readonly", disabled = "true" } })
        </div>
        <div class="col-xs-2 pl0 mb5">
            @Html.EditorFor(m => m.Size9Rate, new { htmlAttributes = new { @class = "form-control", autocomplete = "off", min = 0 } })
        </div>
        <div class="col-xs-2 pl0 mb5">
            @Html.EditorFor(m => m.Size10Caption, new { htmlAttributes = new { @class = "form-control", autocomplete = "off", @readonly = "readonly", disabled = "true" } })
        </div>
        <div class="col-xs-2 pl0 mb5">
            @Html.EditorFor(m => m.Size10Rate, new { htmlAttributes = new { @class = "form-control", autocomplete = "off", min = 0 } })
        </div>
        <div class="col-xs-2 pl0 mb5">
            @Html.EditorFor(m => m.Size11Caption, new { htmlAttributes = new { @class = "form-control", autocomplete = "off", @readonly = "readonly", disabled = "true" } })
        </div>
        <div class="col-xs-2 pl0 mb5">
            @Html.EditorFor(m => m.Size11Rate, new { htmlAttributes = new { @class = "form-control", autocomplete = "off", min = 0 } })
        </div>
        <div class="col-xs-2 pl0 mb5">
            @Html.EditorFor(m => m.Size12Caption, new { htmlAttributes = new { @class = "form-control", autocomplete = "off", @readonly = "readonly", disabled = "true" } })
        </div>
        <div class="col-xs-2 pl0 mb5">
            @Html.EditorFor(m => m.Size12Rate, new { htmlAttributes = new { @class = "form-control", autocomplete = "off", min = 0 } })
        </div>
    </div>
</div>
<div class="form-group">
    @Html.Label(EntityStrings.POSizeRatio, htmlAttributes: new { @class = "control-label col-lg-2 col-md-3 col-sm-3" })
    <div class="col-lg-2 col-md-3 col-sm-3">
        <input id="SizeRatioDivisorDisplay" class="form-control text-right"
               type="number" readonly="readonly" autocomplete="off" value="0" />
        @Html.HiddenFor(m => m.SizeRatioDivisor)
        @Html.ValidationMessageFor(m => m.SizeRatioDivisor, "", new { @class = "text-danger" })
    </div>
</div>
<div class="form-group">
    @Html.LabelFor(model => model.Quantity, htmlAttributes: new { @class = "control-label col-lg-2 col-md-3 col-sm-3" })
    <div class="col-lg-2 col-md-3 col-sm-3">
        @Html.EditorFor(m => m.Quantity, new { htmlAttributes = new { @class = "form-control text-right" } })
        @Html.ValidationMessageFor(m => m.Quantity, "", new { @class = "text-danger" })
    </div>
</div>

<script type="text/javascript">
    var sizingSelect = $('#SizingStandardId');
    var sizingCaptions = [$('#Size1Caption'),$('#Size2Caption'),$('#Size3Caption'),$('#Size4Caption'),$('#Size5Caption'),$('#Size6Caption'),$('#Size7Caption'),$('#Size8Caption'),$('#Size9Caption'),$('#Size10Caption'),$('#Size11Caption'),$('#Size12Caption')];
    var sizingRates = [$('#Size1Rate'),$('#Size2Rate'),$('#Size3Rate'),$('#Size4Rate'),$('#Size5Rate'),$('#Size6Rate'),$('#Size7Rate'),$('#Size8Rate'),$('#Size9Rate'),$('#Size10Rate'),$('#Size11Rate'),$('#Size12Rate')];
    var productList = [];
    var sizingStandards = @Html.Raw(ViewBag.sizingStandards);

    function enableCaptions() {
        $.each(sizingCaptions, function(index, caption){
            caption.prop('disabled', false);
        });
    }
    function setSizingStandard(standardId) {
        if (sizingSelect != null) {
            $("#SizingStandardId > option").each(function () {
                if (this.value == standardId) {
                    $(this).prop('selected', true);
                }
                else {
                    $(this).prop('selected', false);
                }
            });
        }
    }
    function setSizingCaptions() {
        var selectedId = $(sizingSelect).val();
        $.each(sizingCaptions, function (index, caption) {
            caption.val('');
        });
        closeRates();
        if (selectedId != null && selectedId != '') {
            $.each(sizingStandards, function (index, standard) {
                if (selectedId == standard.Id) {
                    $.each(standard.Sizings, function(index, sizing){
                        sizingCaptions[index].val(sizing.Caption);
                        sizingRates[index].prop('readonly', '');
                    });
                }
            });
        }
        $.each(sizingRates, function(index, rate){
            if(rate.prop('readonly')){
                rate.val('');
            }
        });
        calculateDivisor();
    }
    sizingSelect.change(setSizingCaptions);

    function calculateDivisor(evt) {
        if(evt!=null && evt.keyCode==9){//Tab
            return;
        }
        var divisor = 0;

        $.each(sizingRates, function(index, rate){
            rateVal = rate.val();
            if(rateVal!=null && rateVal!=''){
                var rateInt = parseInt(rateVal);
                divisor = divisor + rateInt;
                if(rateInt>0){
                    rate.val(rateInt);
                }
            }
        });

        $('#SizeRatioDivisor').val(divisor);
        $('#SizeRatioDivisorDisplay').val(divisor);
        if(divisor>100){
            $('#Quantity').val(divisor);
        }
    }
    $(document).ready(function () {
        @if (Model.IsApproved || Model.Cancelled)
        {
            @: closeRates();
            @: $('#Quantity').prop('readonly', 'readonly');
            @: $('#DiscountRate').prop('readonly', 'readonly');
        }
        else
        {
            @: initTextBoxes();
        }
        $('#Quantity').on('keydown', numbersOnly);
    });
    function closeRates(){
        $.each(sizingRates, function(index, rate){
            rate.prop('readonly', 'readonly');
        });
    }
    function initTextBoxes(){
        $.each(sizingRates, function(index, rate){
            rate.on('keydown', numbersOnly);
            rate.on('keyup', calculateDivisor);
            rate.on('change', calculateDivisor);
        });
        setSizingCaptions();
    }
</script>